"use strict";var Database=function(t){this.ref=new RefRegistrator(t.refs),this.atomicPriority=new AtomicPriority(t.schema.priority,this.ref),this.schema=new Schema(t.schema,this.atomicPriority),this.query=new Query(this.ref,this.schema),this.server=new Server(this.ref),this.atomicArray=new AtomicArray(this.ref,this.schema,this.server,this.atomicPriority,t.filters),this.atomicFile=new AtomicFile(this.ref)},RefRegistrator=function(t){if(void 0==firebase||null==firebase)throw"Firebase has not been initialized, make sure you initialize it at the end of your index.html (firebase.initializeApp(config);)";this.root=t.root||firebase.database().ref(),this.primary=t.primary,this.secondary=t.secondary||!1,this.foreign=t.foreign||!1,this.rootStorage=t.rootStorage||firebase.storage().ref(),this.primaryStorage=t.primaryStorage||!1};RefRegistrator.prototype.getSecondaryRefs=function(t){var e=this;return new Promise(function(r,i){e.secondary(t).then(function(t){r(t)}).catch(function(t){i(t)})})},RefRegistrator.prototype.getForeignRefs=function(t){var e=this;return new Promise(function(r,i){e.foreign(t).then(function(t){r(t)}).catch(function(t){i(t)})})};var ValueHandler=function(){this.default=null};ValueHandler.prototype.getValue=function(t,e){var r=this,i=typeof t;return void 0==t?r.default:"string"==i||"number"==i||"object"==i||"boolean"==i?r.handleNormal(t,e):"function"==i?r.handleFunction(t,e):void 0},ValueHandler.prototype.handleNormal=function(t,e){return void 0==t&&(t=self.default),t},ValueHandler.prototype.handleFunction=function(t,e){return void 0==t(e)&&(t=self.default),t(e)};var Schema=function(t,e){if(void 0==t||null==t)throw"There was an error in your schema object.Schema couldn't initialize.";var r=new SchemaUtilities;this.atomicPriority=e,this.primary=r.retrieveConfiguration(t.primary),this.secondary=r.retrieveConfiguration(t.secondary),this.foreign=r.retrieveConfiguration(t.foreign)};Schema.prototype.build=function(t,e){var r,i=this;return r="snapshot"==e?t.val():t,void 0==i.getDefaults(t,e).then?i.buildSchemaProperties(i.getDefaults(t,e),r,e):new Promise(function(n,o){i.getDefaults(t,e).then(function(t){n(i.buildSchemaProperties(t,r,e))}).catch(function(t){o(t)})})},Schema.prototype.buildSchemaProperties=function(t,e,r){var i,n=this,o=t;"snapshot"==r?(i=n.primary,r="primary"):i=n[r];for(var a in i)i.hasOwnProperty(a)&&(o[a]=n.getPropertyValue({key:a,value:e[a]},e,r));return o},Schema.prototype.getPropertyValue=function(t,e,r){var i,n=this,o=new ValueHandler;return"="==n[r][t.key].value?(i=o.getValue(t.value,e),void 0!=i&&null!=i||(i=o.getValue(n[r][t.key].default,e))):(i=o.getValue(n[r][t.key].value,e),void 0!=i&&null!=i||o.getValue(n[r][t.key].default,e)),i},Schema.prototype.getDefaults=function(t,e){var r=this;return"custom"==r.atomicPriority.order?new Promise(function(i,n){r.atomicPriority.getPriority(t).then(function(n){i(r.default[e](t,n))}).catch(function(t){n(t)})}):r.default[e](t,r.atomicPriority.getPriority(t))},Schema.prototype.default={snapshot:function(t,e){return{$key:t.$key||t.key,creationTS:t.val().creationTS,lastEventTS:t.val().lastEventTS,latestServerTS:t.val().latestServerTS,$priority:t.getPriority()||e}},primary:function(t,e){var r=(new Date).getTime();return{creationTS:t.creationTS||r,lastEventTS:r,latestServerTS:firebase.database.ServerValue.TIMESTAMP,".priority":t.$priority||e}},secondary:function(t,e){var r=(new Date).getTime();return{creationTS:t.creationTS||r,lastEventTS:r,latestServerTS:firebase.database.ServerValue.TIMESTAMP,".priority":t.$priority||e}},foreign:function(t,e){var r=(new Date).getTime();return{key:t.$key||t.key,creationTS:t.creationTS||r,lastEventTS:r,latestServerTS:firebase.database.ServerValue.TIMESTAMP,".priority":t.$priority||e}}};var SchemaUtilities=function(){};SchemaUtilities.prototype.retrieveConfiguration=function(t){var e={};if(!t)return e=!1;for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r]);return e};var Query=function(t,e){this.ref=t,this.schema=e};Query.prototype.create=function(t){var e=this,r={},i=e.ref.root.child(e.ref.primary);return new Promise(function(n,o){i.push(e.schema.build(t,"primary")).then(function(i){t.$key=i.key,e.ref.secondary?e.ref.getSecondaryRefs(t).then(function(i){for(var a=0;a<i.length;a++)r[i[a]]=e.schema.build(t,"secondary");e.processFanoutObject(r).then(function(e){n(t.$key)}).catch(function(t){o(t)})}).catch(function(t){o(t)}):n(t.$key)}).catch(function(t){o(t)})})},Query.prototype.update=function(t){var e=this;return new Promise(function(r,i){e.alter(t,"update").then(function(t){r(t)}).catch(function(t){i(t)})})},Query.prototype.remove=function(t){var e=this;return new Promise(function(r,i){e.alter(t,"update").then(function(n){e.alter(t,"remove").then(function(t){r(t)}).catch(function(t){i(t)})}).catch(function(t){i(t)})})},Query.prototype.alter=function(t,e){var r,i,n,o=this,a={};return"update"==e?(r=o.schema.build(t,"primary"),i=o.schema.build(t,"secondary"),n=o.schema.build(t,"foreign")):"remove"==e&&(r={},i={},n={}),new Promise(function(e,c){var s;s=void 0==t.$key?t.key:t.$key,a[o.ref.primary+"/"+s]=r,o.ref.secondary&&o.ref.foreign?o.ref.secondary(t).then(function(r){o.ref.foreign(t).then(function(t){for(var s=0;s<r.length;s++)a[r[s]]=i;for(var s=0;s<t.length;s++)a[t[s]]=n;o.processFanoutObject(a).then(function(t){e(t)}).catch(function(t){c(t)})}).catch(function(t){c(t)})}).catch(function(t){c(t)}):o.ref.secondary&&!o.ref.foreign?o.ref.secondary(t).then(function(t){for(var r=0;r<t.length;r++)a[t[r]]=i;o.processFanoutObject(a).then(function(t){e(t)}).catch(function(t){c(t)})}).catch(function(t){c(t)}):!o.ref.secondary&&o.ref.foreign?o.ref.foreign(t).then(function(t){for(var r=0;r<t.length;r++)a[t[r]]=n;o.processFanoutObject(a).then(function(t){e(t)}).catch(function(t){c(t)})}).catch(function(t){c(t)}):o.processFanoutObject(a).then(function(t){e(t)}).catch(function(t){c(t)})})},Query.prototype.processFanoutObject=function(t){var e=this;return new Promise(function(r,i){e.ref.root.update(t).then(function(t){r(t)}).catch(function(t){i(t)})})},Query.prototype.set=function(t){var e=this,r=e.ref.root.child(e.ref.primary);return new Promise(function(i,n){r.set(e.schema.build(t,"primary")).then(function(t){i(!0)}).catch(function(t){n(t)})})};var AtomicArray=function(t,e,r,i,n){this.ref=t,this.schema=e,this.server=r,this.atomicPriority=i,this.filters=n};AtomicArray.prototype.$on=function(t){var e=this;return e.id=0,void 0!=t?(e.arrayRef=t.ref||e.ref.primary,e.query={initialLotSize:t.initialLotSize||10,nextLotSize:t.nextLotSize||12}):(e.arrayRef=e.ref.primary,e.query={initialLotSize:10,nextLotSize:12}),e.eventListenerRef=null,e.displayedItems=0,e.subscribed=!1,e.initialLotLoaded=!1,e.itemsRemaining=!0,e.fetching=!1,e.items=[],new Promise(function(t,r){e.loadInitialLot().then(function(e){t(e)}).catch(function(t){r(t)})})},AtomicArray.prototype.loadInitialLot=function(){var t=this;return new Promise(function(e,r){var i=t.ref.root.child(t.arrayRef).limitToFirst(t.query.initialLotSize);i.once("value").then(function(i){t.server.updateTS().then(function(){t.server.getTS().then(function(r){i.forEach(function(e){t.addItem(e,!1)}),t.eventListenerRef=t.ref.root.child(t.arrayRef).orderByChild("latestServerTS").startAt(r),t.id=t.generateInstanceID(),t.initialLotLoaded=!0,t.subscribe(),t.applyFilters(),e(t.id)}).catch(function(t){r(t)})}).catch(function(t){r(t)})})})},AtomicArray.prototype.loadNextLot=function(){var t=this;return new Promise(function(e,r){if(t.fetching||void 0==t.items[parseInt(t.displayedItems)-1])setTimeout(function(){e(!1)},4e3);else{t.fetching=!0;var i=t.items.length,n=t.ref.root.child(t.arrayRef).startAt(t.items[parseInt(t.displayedItems)-1].$priority+1).limitToFirst(t.query.nextLotSize);n.once("value").then(function(r){r.forEach(function(e){t.addItem(e,!1)}),i==t.items.length&&(t.itemsRemaining=!1),t.applyFilters(),t.fetching=!1,e(!0)}).catch(function(t){r(t)})}})},AtomicArray.prototype.applyFilters=function(){var t=this;t.items.sort(t.sortItems()),document.dispatchEvent(new CustomEvent(t.id+"_apply_filters"))},AtomicArray.prototype.subscribe=function(){var t=this;t.subscribed=!0,t.eventListenerRef.on("child_added",function(e){t.addItem(e,!0),t.applyFilters()}),t.eventListenerRef.on("child_changed",function(e){t.editItem(e),t.applyFilters()}),t.eventListenerRef.on("child_moved",function(e){t.editItem(e),t.applyFilters()}),t.eventListenerRef.on("child_removed",function(e){t.removeItem(e),t.applyFilters()})},AtomicArray.prototype.$off=function(){this.unsubscribe(),this.resetDefaults()},AtomicArray.prototype.unsubscribe=function(){var t=this;t.subscribed&&(t.eventListenerRef.off("child_added"),t.eventListenerRef.off("child_changed"),t.eventListenerRef.off("child_moved"),t.eventListenerRef.off("child_removed"),t.subscribed=!1)},AtomicArray.prototype.resetDefaults=function(){this.arrayRef=null,this.query=null,this.eventListenerRef=null,this.displayedItems=0,this.subscribed=!1,this.initialLotLoaded=!1,this.itemsRemaining=!0,this.fetching=!1,this.items=[]},AtomicArray.prototype.addItem=function(t,e){var r=this;if(!r.itemExists(t)){var i=r.schema.build(t,"snapshot");e&&(i.isNew=!0),r.items.push(i),r.displayedItems+=1}},AtomicArray.prototype.editItem=function(t){for(var e=this,r=e.schema.build(t,"snapshot"),i=0;i<e.items.length;i++)e.items[i].$key==r.$key&&(e.items[i]=r)},AtomicArray.prototype.removeItem=function(t){for(var e=this,r=0;r<e.items.length;r++)e.items[r].$key==t.key&&(e.items.splice(r,1),e.displayedItems-=1)},AtomicArray.prototype.itemExists=function(t){for(var e=this,r=!1,i=0;i<e.items.length;i++)e.items[i].$key==t.key&&(r=!0);return r},AtomicArray.prototype.sortItems=function(){var t=this;return"string"==typeof t.atomicPriority.orderSelected?t.builtInSort[t.atomicPriority.orderSelected]:"function"==typeof t.atomicPriority.orderSelected?t.builtInSort.dateDesc:void 0},AtomicArray.prototype.builtInSort={custom:function(t,e){return t.$priority-e.$priority},dateDesc:function(t,e){return t.$priority-e.$priority},dateAsc:function(t,e){return t.$priority+e.$priority}},AtomicArray.prototype.generateInstanceID=function(){return this.generateRandomNumbers()+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()},AtomicArray.prototype.generateRandomNumbers=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};var AtomicObject=function(t,e){this.db=t,this.objectRef=this.db.ref.root.child(e||this.db.ref.primary),this.item={}};AtomicObject.prototype.initialize=function(){var t=this;return new Promise(function(e,r){t.objectRef.on("value",function(r){r&&(t.item=t.db.schema.build(r,"snapshot"),document.dispatchEvent(new CustomEvent("object_changed")),e(!0))})})},AtomicObject.prototype.$off=function(){this.objectRef.off()};var AtomicPriority=function(t,e){this.ref=e,this.increment=5e7,void 0==t?this.orderSelected="dateDesc":(this.orderSelected=t.order,this.childAdded=t.childAdded||"last")};AtomicPriority.prototype.getPriority=function(t){var e=this;return void 0!=e.orderSelected?"custom"==e.orderSelected?new Promise(function(t,r){e[e.childAdded]().then(function(e){t(e)}).catch(function(t){r(t)})}):"function"==typeof e.orderSelected?e.orderSelected(t):e[e.orderSelected]():e.dateDesc()},AtomicPriority.prototype.dateDesc=function(){var t=(new Date).getTime();return-t},AtomicPriority.prototype.dateAsc=function(){return(new Date).getTime()},AtomicPriority.prototype.first=function(){var t=this,e=t.ref.root.child(t.ref.primary).orderByPriority().limitToFirst(1);return new Promise(function(r,i){e.once("value").then(function(e){if(e.val()){var i=0;e.forEach(function(t){i=t.getPriority()}),r(i/2)}else r(t.increment)}).catch(function(t){i(t)})})},AtomicPriority.prototype.last=function(){var t=this,e=t.ref.root.child(t.ref.primary).orderByPriority().limitToLast(1);return new Promise(function(r,i){e.once("value").then(function(e){if(e.val()){var i=0;e.forEach(function(t){i=t.getPriority()}),r(i+t.increment)}else r(t.increment)}).catch(function(t){i(t)})})},AtomicPriority.prototype.previous=function(t){var e=this,r=e.ref.root.child(e.ref.primary).orderByPriority().endAt(t.$priority).limitToLast(2);return new Promise(function(t,e){r.once("value").then(function(e){var r=0;e.forEach(function(t){r+=t.getPriority()}),t(r/2)}).catch(function(t){e(t)})})},AtomicPriority.prototype.next=function(t){var e=this,r=e.ref.root.child(e.ref.primary).orderByPriority().startAt(t.$priority).limitToFirst(2);return new Promise(function(t,e){r.once("value").then(function(e){var r=0;e.forEach(function(t){r+=t.getPriority()}),t(r/2)}).catch(function(t){e(t)})})},AtomicPriority.prototype.isFirst=function(t){var e=this;return new Promise(function(r,i){e.first().then(function(e){r(t.$priority==e?!0:!1)}).catch(function(t){i(t)})})},AtomicPriority.prototype.isLast=function(t){var e=this;return new Promise(function(r,i){e.last().then(function(e){r(t.$priority==e?!0:!1)}).catch(function(t){i(t)})})};var AtomicFile=function(t){this.ref=t,this.progress=0};AtomicFile.prototype.upload=function(t,e){var r=this;return r.progress=0,new Promise(function(i,n){var o=r.generateName(t),a=r.ref.rootStorage.child(e||r.ref.primaryStorage).child(o).put(t);a.on(firebase.storage.TaskEvent.STATE_CHANGED,function(t){r.progress=t.bytesTransferred/t.totalBytes*100},function(t){n(t)},function(){var t=a.snapshot.downloadURL;i({fileName:o,fileUrl:t})})})},AtomicFile.prototype.delete=function(t,e){var r=this;return new Promise(function(i,n){r.ref.rootStorage.child(e||r.ref.primaryStorage+"/"+t).delete().then(function(){i(!0)}).catch(function(t){n(t)})})},AtomicFile.prototype.generateName=function(t){return this.generateRandomNumbers()+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+this.generateRandomNumbers()+this.generateRandomNumbers()+"."+this.getFileExtension(t)},AtomicFile.prototype.generateRandomNumbers=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},AtomicFile.prototype.getFileExtension=function(t){return"image/jpeg"==t.type?"jpeg":"image/gif"==t.type?"gif":"image/png"==t.type?"png":"image/svg+xml"==t.type?"svg":void 0};var Server=function(t){this.serverRef=t.root.child("atomicBase/server")};Server.prototype.updateTS=function(){var t=this;return new Promise(function(e,r){t.serverRef.set({TS:firebase.database.ServerValue.TIMESTAMP}).then(function(t){e(t)}).catch(function(t){r(t)})})},Server.prototype.getTS=function(){var t=this;return new Promise(function(e,r){t.serverRef.once("value").then(function(t){e(t.val().TS)}).catch(function(t){r(t)})})};