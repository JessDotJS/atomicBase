"use strict";var Database=function(e){this.ref=new RefRegistrator(e.refs),this.atomicPriority=new AtomicPriority(e.schema.priority||null,this.ref),this.schema=new Schema(e.schema,this.atomicPriority),this.query=new Query(this.ref,this.schema),this.server=new Server(this.ref),this.atomicArray=new AtomicArray(this.ref,this.schema,this.server,this.atomicPriority,e.filters),this.atomicFile=new AtomicFile(this.ref)},RefRegistrator=function(e){if(void 0==firebase||null==firebase)throw"Firebase has not been initialized, make sure you initialize it at the end of your index.html (firebase.initializeApp(config);)";this.root=e.root||firebase.database().ref(),this.primary=e.primary,this.secondary=e.secondary||!1,this.foreign=e.foreign||!1,this.rootStorage=e.rootStorage||firebase.storage().ref(),this.primaryStorage=e.primaryStorage||!1};RefRegistrator.prototype.getSecondaryRefs=function(e){var t=this;return new Promise(function(r,i){t.secondary(e).then(function(e){r(e)}).catch(function(e){i(e)})})},RefRegistrator.prototype.getForeignRefs=function(e){var t=this;return new Promise(function(r,i){t.foreign(e).then(function(e){r(e)}).catch(function(e){i(e)})})};var ValueHandler=function(){this.default=null};ValueHandler.prototype.getValue=function(e,t){var r=this,i=typeof e;return void 0==e?r.default:"string"==i||"number"==i||"object"==i||"boolean"==i?r.handleNormal(e,t):"function"==i?r.handleFunction(e,t):void 0},ValueHandler.prototype.handleNormal=function(e,t){return void 0==e&&(e=self.default),e},ValueHandler.prototype.handleFunction=function(e,t){return void 0==e(t)&&(e=self.default),e(t)};var Schema=function(e,t){if(void 0==e||null==e)throw"There was an error in your schema object.Schema couldn't initialize.";var r=new SchemaUtilities;this.atomicPriority=t,this.primary=r.retrieveConfiguration(e.primary),this.secondary=r.retrieveConfiguration(e.secondary),this.foreign=r.retrieveConfiguration(e.foreign)};Schema.prototype.build=function(e,t){var r,i=this;return r="snapshot"==t?e.val():e,void 0==i.getDefaults(e,t).then?i.buildSchemaProperties(i.getDefaults(e,t),r,t):new Promise(function(n,o){i.getDefaults(e,t).then(function(e){n(i.buildSchemaProperties(e,r,t))}).catch(function(e){o(e)})})},Schema.prototype.buildSchemaProperties=function(e,t,r){var i,n=this,o=e;"snapshot"==r?(i=n.primary,r="primary"):i=n[r];for(var a in i)i.hasOwnProperty(a)&&(o[a]=n.getPropertyValue({key:a,value:t[a]},t,r));return o},Schema.prototype.getPropertyValue=function(e,t,r){var i,n=this,o=new ValueHandler;return"="==n[r][e.key].value?void 0!=(i=o.getValue(e.value,t))&&null!=i||(i=o.getValue(n[r][e.key].default,t)):void 0!=(i=o.getValue(n[r][e.key].value,t))&&null!=i||o.getValue(n[r][e.key].default,t),i},Schema.prototype.getDefaults=function(e,t){var r=this;return"custom"==r.atomicPriority.order?new Promise(function(i,n){r.atomicPriority.getPriority(e).then(function(n){i(r.default[t](e,n))}).catch(function(e){n(e)})}):r.default[t](e,r.atomicPriority.getPriority(e))},Schema.prototype.default={snapshot:function(e,t){return e.exists()?{$key:e.$key||e.key,creationTS:e.val().creationTS,lastEventTS:e.val().lastEventTS,latestServerTS:e.val().latestServerTS,$priority:e.getPriority()||t}:{}},primary:function(e,t){if(void 0!=e&&null!=e){var r=(new Date).getTime();return{creationTS:e.creationTS||r,lastEventTS:r,latestServerTS:firebase.database.ServerValue.TIMESTAMP,".priority":e.$priority||t}}return{}},secondary:function(e,t){if(void 0!=e&&null!=e){var r=(new Date).getTime();return{creationTS:e.creationTS||r,lastEventTS:r,latestServerTS:firebase.database.ServerValue.TIMESTAMP,".priority":e.$priority||t}}return{}},foreign:function(e,t){if(void 0!=e&&null!=e){var r=(new Date).getTime();return{key:e.$key||e.key,creationTS:e.creationTS||r,lastEventTS:r,latestServerTS:firebase.database.ServerValue.TIMESTAMP,".priority":e.$priority||t}}return{}}};var SchemaUtilities=function(){};SchemaUtilities.prototype.retrieveConfiguration=function(e){var t={};if(!e)return t=!1;for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t};var Query=function(e,t){this.ref=e,this.schema=t};Query.prototype.create=function(e){var t=this,r={},i=t.ref.root.child(t.ref.primary);return new Promise(function(n,o){i.push(t.schema.build(e,"primary")).then(function(i){e.$key=i.key,t.ref.secondary?t.ref.getSecondaryRefs(e).then(function(i){for(var a=0;a<i.length;a++)r[i[a]]=t.schema.build(e,"secondary");t.processFanoutObject(r).then(function(t){n(e.$key)}).catch(function(e){o(e)})}).catch(function(e){o(e)}):n(e.$key)}).catch(function(e){o(e)})})},Query.prototype.update=function(e){var t=this;return new Promise(function(r,i){t.alter(e,"update").then(function(e){r(!0)}).catch(function(e){i(e)})})},Query.prototype.remove=function(e){var t=this;return new Promise(function(r,i){t.alter(e,"update").then(function(n){t.alter(e,"remove").then(function(e){r(e)}).catch(function(e){i(e)})}).catch(function(e){i(e)})})},Query.prototype.alter=function(e,t){var r,i,n,o=this,a={};return"update"==t?(r=o.schema.build(e,"primary"),i=o.schema.build(e,"secondary"),n=o.schema.build(e,"foreign")):"remove"==t&&(r={},i={},n={}),new Promise(function(t,c){var s;s=void 0==e.$key?e.key:e.$key,a[o.ref.primary+"/"+s]=r,o.ref.secondary&&o.ref.foreign?o.ref.secondary(e).then(function(r){o.ref.foreign(e).then(function(e){for(var s=0;s<r.length;s++)a[r[s]]=i;for(var s=0;s<e.length;s++)a[e[s]]=n;o.processFanoutObject(a).then(function(e){t(e)}).catch(function(e){c(e)})}).catch(function(e){c(e)})}).catch(function(e){c(e)}):o.ref.secondary&&!o.ref.foreign?o.ref.secondary(e).then(function(e){for(var r=0;r<e.length;r++)a[e[r]]=i;o.processFanoutObject(a).then(function(e){t(e)}).catch(function(e){c(e)})}).catch(function(e){c(e)}):!o.ref.secondary&&o.ref.foreign?o.ref.foreign(e).then(function(e){for(var r=0;r<e.length;r++)a[e[r]]=n;o.processFanoutObject(a).then(function(e){t(e)}).catch(function(e){c(e)})}).catch(function(e){c(e)}):o.processFanoutObject(a).then(function(e){t(e)}).catch(function(e){c(e)})})},Query.prototype.processFanoutObject=function(e){var t=this;return new Promise(function(r,i){t.ref.root.update(e).then(function(e){r(e)}).catch(function(e){i(e)})})},Query.prototype.set=function(e){var t=this,r=t.ref.root.child(t.ref.primary);return new Promise(function(i,n){r.set(t.schema.build(e,"primary")).then(function(e){i(!0)}).catch(function(e){n(e)})})};var AtomicArray=function(e,t,r,i,n){this.ref=e,this.schema=t,this.server=r,this.atomicPriority=i,this.filters=n};AtomicArray.prototype.$on=function(e){var t=this;return t.id=0,void 0!=e?(t.arrayRef=e.ref||t.ref.primary,t.query={initialLotSize:e.initialLotSize||10,nextLotSize:e.nextLotSize||12}):(t.arrayRef=t.ref.primary,t.query={initialLotSize:10,nextLotSize:12}),t.eventListenerRef=null,t.displayedItems=0,t.subscribed=!1,t.initialLotLoaded=!1,t.itemsRemaining=!0,t.fetching=!1,t.items=[],new Promise(function(e,r){t.loadInitialLot().then(function(t){e(t)}).catch(function(e){r(e)})})},AtomicArray.prototype.loadInitialLot=function(){var e=this;return new Promise(function(t,r){e.ref.root.child(e.arrayRef).limitToFirst(e.query.initialLotSize).once("value").then(function(i){e.server.updateTS().then(function(){e.server.getTS().then(function(r){i.forEach(function(t){e.addItem(t,!1)}),e.eventListenerRef=e.ref.root.child(e.arrayRef).orderByChild("latestServerTS").startAt(r),e.id=e.generateInstanceID(),e.initialLotLoaded=!0,e.subscribe(),e.applyFilters(),t(e.id)}).catch(function(e){r(e)})}).catch(function(e){r(e)})})})},AtomicArray.prototype.loadNextLot=function(){var e=this;return new Promise(function(t,r){if(!e.fetching&&void 0!=e.items[parseInt(e.displayedItems)-1]!=void 0&&e.itemsRemaining){e.fetching=!0;var i=e.items.length;e.ref.root.child(e.arrayRef).startAt(e.items[parseInt(e.displayedItems)-1].$priority+1).limitToFirst(e.query.nextLotSize).once("value").then(function(r){r.forEach(function(t){e.addItem(t,!1)}),i==e.items.length&&(e.itemsRemaining=!1),e.applyFilters(),setTimeout(function(){e.fetching=!1,t(!0)},5e3)}).catch(function(e){r(e)})}else t(!1)})},AtomicArray.prototype.applyFilters=function(){var e=this;e.items.sort(e.sortItems()),document.dispatchEvent(new CustomEvent(e.id+"_apply_filters"))},AtomicArray.prototype.subscribe=function(){var e=this;e.subscribed=!0,e.eventListenerRef.on("child_added",function(t){e.addItem(t,!0),e.applyFilters()}),e.eventListenerRef.on("child_changed",function(t){e.editItem(t),e.applyFilters()}),e.eventListenerRef.on("child_moved",function(t){e.editItem(t),e.applyFilters()}),e.eventListenerRef.on("child_removed",function(t){e.removeItem(t),e.applyFilters()})},AtomicArray.prototype.$off=function(){this.unsubscribe(),this.resetDefaults()},AtomicArray.prototype.unsubscribe=function(){var e=this;e.subscribed&&(e.eventListenerRef.off("child_added"),e.eventListenerRef.off("child_changed"),e.eventListenerRef.off("child_moved"),e.eventListenerRef.off("child_removed"),e.subscribed=!1)},AtomicArray.prototype.resetDefaults=function(){this.arrayRef=null,this.query=null,this.eventListenerRef=null,this.displayedItems=0,this.subscribed=!1,this.initialLotLoaded=!1,this.itemsRemaining=!0,this.fetching=!1,this.items=[]},AtomicArray.prototype.addItem=function(e,t){var r=this;if(!r.itemExists(e)){var i=r.schema.build(e,"snapshot");t&&(i.isNew=!0),r.items.push(i),r.displayedItems+=1}},AtomicArray.prototype.editItem=function(e){for(var t=this,r=t.schema.build(e,"snapshot"),i=0;i<t.items.length;i++)t.items[i].$key==r.$key&&(t.items[i]=r)},AtomicArray.prototype.removeItem=function(e){for(var t=this,r=0;r<t.items.length;r++)t.items[r].$key==e.key&&(t.items.splice(r,1),t.displayedItems-=1)},AtomicArray.prototype.itemExists=function(e){for(var t=this,r=!1,i=0;i<t.items.length;i++)t.items[i].$key==e.key&&(r=!0);return r},AtomicArray.prototype.sortItems=function(){var e=this;return"string"==typeof e.atomicPriority.orderSelected?e.builtInSort[e.atomicPriority.orderSelected]:"function"==typeof e.atomicPriority.orderSelected?e.builtInSort.dateDesc:void 0},AtomicArray.prototype.builtInSort={custom:function(e,t){return e.$priority-t.$priority},dateDesc:function(e,t){return e.$priority-t.$priority},dateAsc:function(e,t){return e.$priority+t.$priority}},AtomicArray.prototype.generateInstanceID=function(){return this.generateRandomNumbers()+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()},AtomicArray.prototype.generateRandomNumbers=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};var AtomicObject=function(e,t){this.db=e,this.objectRef=this.db.ref.root.child(t||this.db.ref.primary),this.item={},self.eventListenerRef={}};AtomicObject.prototype.$on=function(){var e=this;return e.id=0,new Promise(function(t,r){e.db.server.getLatestTS().then(function(r){e.objectRef.once("value",function(r){e.item=e.db.schema.build(r,"snapshot"),e.id=e.generateInstanceID(),e.subscribe(),t(e.id)})}).catch(function(e){r(e)})})},AtomicObject.prototype.subscribe=function(){var e=this;e.subscribed=!0,e.objectRef.on("child_changed",function(t){e.item[t.key]=t.val(),document.dispatchEvent(new CustomEvent(e.id+"_object_changed"))}),e.objectRef.on("child_moved",function(t){e.item[t.key]=t.val(),document.dispatchEvent(new CustomEvent(e.id+"_object_changed"))}),e.objectRef.on("child_removed",function(t){e.item[t.key]={},document.dispatchEvent(new CustomEvent(e.id+"_object_changed"))})},AtomicObject.prototype.$off=function(){this.unsubscribe()},AtomicArray.prototype.unsubscribe=function(){var e=this;e.objectRef&&(e.objectRef.off("child_changed"),e.objectRef.off("child_moved"),e.objectRef.off("child_removed"))},AtomicObject.prototype.generateInstanceID=function(){return this.generateRandomNumbers()+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()},AtomicObject.prototype.generateRandomNumbers=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};var AtomicPriority=function(e,t){this.ref=t,this.increment=5e7,void 0==e?this.orderSelected="dateDesc":(this.orderSelected=e.order,this.childAdded=e.childAdded||"last")};AtomicPriority.prototype.getPriority=function(e){var t=this;return void 0!=t.orderSelected?"custom"==t.orderSelected?new Promise(function(e,r){t[t.childAdded]().then(function(t){e(t)}).catch(function(e){r(e)})}):"function"==typeof t.orderSelected?t.orderSelected(e):t[t.orderSelected]():t.dateDesc()},AtomicPriority.prototype.dateDesc=function(){return-(new Date).getTime()},AtomicPriority.prototype.dateAsc=function(){return(new Date).getTime()},AtomicPriority.prototype.first=function(){var e=this,t=e.ref.root.child(e.ref.primary).orderByPriority().limitToFirst(1);return new Promise(function(r,i){t.once("value").then(function(t){if(t.val()){var i=0;t.forEach(function(e){i=e.getPriority()}),r(i/2)}else r(e.increment)}).catch(function(e){i(e)})})},AtomicPriority.prototype.last=function(){var e=this,t=e.ref.root.child(e.ref.primary).orderByPriority().limitToLast(1);return new Promise(function(r,i){t.once("value").then(function(t){if(t.val()){var i=0;t.forEach(function(e){i=e.getPriority()}),r(i+e.increment)}else r(e.increment)}).catch(function(e){i(e)})})},AtomicPriority.prototype.previous=function(e){var t=this,r=t.ref.root.child(t.ref.primary).orderByPriority().endAt(e.$priority).limitToLast(2);return new Promise(function(e,t){r.once("value").then(function(t){var r=0;t.forEach(function(e){r+=e.getPriority()}),e(r/2)}).catch(function(e){t(e)})})},AtomicPriority.prototype.next=function(e){var t=this,r=t.ref.root.child(t.ref.primary).orderByPriority().startAt(e.$priority).limitToFirst(2);return new Promise(function(e,t){r.once("value").then(function(t){var r=0;t.forEach(function(e){r+=e.getPriority()}),e(r/2)}).catch(function(e){t(e)})})},AtomicPriority.prototype.isFirst=function(e){var t=this;return new Promise(function(r,i){t.first().then(function(t){r(e.$priority==t?!0:!1)}).catch(function(e){i(e)})})},AtomicPriority.prototype.isLast=function(e){var t=this;return new Promise(function(r,i){t.last().then(function(t){r(e.$priority==t?!0:!1)}).catch(function(e){i(e)})})};var AtomicFile=function(e){this.ref=e,this.progress=0};AtomicFile.prototype.upload=function(e,t){var r=this;return r.progress=0,new Promise(function(i,n){var o=r.generateName(e),a=r.ref.rootStorage.child(t||r.ref.primaryStorage).child(o).put(e);a.on(firebase.storage.TaskEvent.STATE_CHANGED,function(e){r.progress=e.bytesTransferred/e.totalBytes*100},function(e){n(e)},function(){var e=a.snapshot.downloadURL;i({fileName:o,fileUrl:e})})})},AtomicFile.prototype.delete=function(e,t){var r=this;return new Promise(function(i,n){r.ref.rootStorage.child(t||r.ref.primaryStorage+"/"+e).delete().then(function(){i(!0)}).catch(function(e){n(e)})})},AtomicFile.prototype.generateName=function(e){return this.generateRandomNumbers()+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+"-"+this.generateRandomNumbers()+this.generateRandomNumbers()+this.generateRandomNumbers()+"."+this.getFileExtension(e)},AtomicFile.prototype.generateRandomNumbers=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)},AtomicFile.prototype.getFileExtension=function(e){return"image/jpeg"==e.type?"jpeg":"image/gif"==e.type?"gif":"image/png"==e.type?"png":"image/svg+xml"==e.type?"svg":void 0};var Server=function(e){this.serverRef=e.root.child("atomicBase/server")};Server.prototype.updateTS=function(){var e=this;return new Promise(function(t,r){e.serverRef.set({TS:firebase.database.ServerValue.TIMESTAMP}).then(function(e){t(e)}).catch(function(e){r(e)})})},Server.prototype.getTS=function(){var e=this;return new Promise(function(t,r){e.serverRef.once("value").then(function(e){t(e.val().TS)}).catch(function(e){r(e)})})},Server.prototype.getLatestTS=function(){var e=this;return new Promise(function(t,r){e.updateTS().then(function(i){e.getTS().then(function(e){t(e)}).catch(function(e){r(e)})}).catch(function(e){r(e)})})};